<html>
<head>
    <title>Hands On Scala Native</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="assets/styles/libs.css"/>

    <link rel="stylesheet" href="assets/styles/app.css"/>
</head>
<body class="light">
  <div class="reveal">
    <div class="slides">



<section>
  <h2>Hands-on</h2>
  <h2>Scala-Native<h2>
  <img alt="Scala Center Logo" src="img/scala-center-logo.png">
</section>




<section>
  <h2>Presentation Plan</h2>
  <ul>
    <li>What is Scala-Native ?</li>
    <li>...</li>
    <li>...</li>
    <li>...</li>
    <li>...</li>
  </ul>
</section>





<section>
  <h2>What is Scala-Native ?<h2>
 
</section>






<section>

</section>








<section>
<pre><code data-trim data-noescape>
┌[ 1.59 KiB/s ]─[ nbwmon-0.6 | interface: wlp4s0 ]─[ Received ]┐
│-              *                                              │
│-              *                                        *     │
│-              *   *                                    *     │
│-              *   *                                    *     │
│-              *   *            *                       *     │
└[ 0 B/s ]─────────────────────────────────────────────────────┘
┌[ 3.74 KiB/s ]─────────────────────────────────[ Transmitted ]┐
│-                               *                             │
│-              *                *                       *     │
│-              *   *            **                      *     │
│-              *   *   **      ****                 *   *    *│
│-              *   *   **** *  **** * ** * **   *   *  **    *│
└[ 0 B/s ]─────────────────────────────────────────────────────┘
┌[ Received ]──────────────────┐┌[ Transmitted ]───────────────┐
│Current:               384 B/s││Current:               564 B/s│
│Maximum:            1.59 KiB/s││Maximum:            3.74 KiB/s│
│Average:               113 B/s││Average:               164 B/s│
│Minimum:                 0 B/s││Minimum:                 0 B/s│
│Total:                3.65 GiB││Total:                2.88 GiB│
│                              ││                              │
└──────────────────────────────┘└──────────────────────────────┘
</code></pre>
<mark>https://github.com/causes-/nbwmon</mark>
</section>








<section>
  <h1>Code: <a class="code-link" href="https://git.io/vSMS7">git.io/vSMS7</a></h1>
</section>








<section>
<h4>System Setup</h4>

macOS:
<pre>brew install <mark>llvm bdw-gc</mark> ncurses</pre>

Ubuntu:
<pre>sudo apt-get install <mark>clang libgc-dev libunwind-dev</mark> libncurses-dev</pre>

Nix:
<pre>nix-shell .</pre>

</section>











<section>
<h4>Sbt Setup</h4>
project/plugins.sbt
<pre><code data-trim data-noescape>
addSbtPlugin(<mark>"org.scala-native" % "sbt-scala-native" % "0.1.0"</mark>)
</code></pre>

build.sbt
<pre><code data-trim data-noescape>
enablePlugins(<mark>ScalaNativePlugin</mark>)

scalaVersion := "2.11.8"
</code></pre>
</section>





<section>


  <section>
    <h1>DEMO</h1>
  </section>



  <section>
    <img src="img/out.gif" alt="nbwmon terminal demo">
  </section>


</section>








<section>
  <section>
    <h2>Implementation Plan</h2>
    <ul>
      <li><mark>Redraw Loop</mark></li>
      <li>Find Network Interface Name</li>
      <li>Get Bitrate</li>
      <li>Draw Bitrate Graph</li>
    </ul>
  </section>


  <section>
    <h4>Redraw Loop</h4>
  <pre><code data-trim data-noescape>
  def waitLoop(body: => Unit): Unit = {
      var timer  = 0L
      var redraw = false
      val tv: <mark>Ptr[timeval]</mark> = <mark>stackalloc[timeval]</mark>
      var key = 0
      while (key != 'q') {
        gettimeofday(tv, null)
        if (timer < tv.tv_sec) { // +1 second
          timer = tv.tv_sec
          redraw = true
        }
        if (redraw) {
          body
          redraw = false
        }
        key = getch()
      }
    }
  </code></pre>
  </section>

  <section>
  <h4>Interropt with C</h4>
  <pre><code data-trim data-noescape>
  import scalanative.native._

  <mark>@extern</mark>
  object posix {
    import posixh._
    def gettimeofday(tv: Ptr[timeval], tz: Ptr[timezone]): Unit = 
      <mark>extern</mark>
  }

  object posixh {
    type time_t      = CLong
    type suseconds_t = CLong
    type timeval     = <mark>CStruct2[time_t, suseconds_t]</mark>
    type timezone    = <mark>CStruct0</mark>

    implicit class timevalOps(val ptr: Ptr[timeval]) {
      def tv_sec: time_t       = <mark>!(ptr._1)</mark>
      def tv_usec: suseconds_t = <mark>!(ptr._2)</mark>
    }
  }
  </code></pre>
  </section>

  <section>
    <h4>Redraw Loop</h4>
  <pre><code data-trim data-noescape>
  object LoopMain {
    def main(args: Array[String]): Unit = {
      waitLoop {
        println("tick")
      }
    }
  }
  </code></pre>
  </section>
</section>





<section>
  <section>
    <h2>Implementation Plan</h2>
    <ul>
      <li>Redraw Loop</li>
      <li><mark>Find Network Interface Name</mark></li>
      <li>Get Bitrate</li>
      <li>Draw Bitrate Graph</li>
    </ul>
  </section>


  <section>
  <h4><mark>Find</mark> Network Interface Name</h4>
  <pre><code data-trim data-noescape>
  def findInterface: Option[String] = {
    withIfaddrs(_.<mark>find</mark>(interface =>
       (interface.flags & Up) &&
       (interface.flags & Running) &&
      !(interface.flags & Loopback)
    ).map(interface => fromCString(<mark>interface.name</mark>)))
  }

  def withIfaddrs[A](f: <mark>Iterator</mark>[IfaddrsOps] => A): A = {
    val ifaddrs = stackalloc[Ptr[Ifaddrs]]

    if (getifaddrs(ifaddrs) != -1) {
      val ret = <mark>f((!ifaddrs).iterator)</mark>
      freeifaddrs(!ifaddrs)
      ret
    } else {
      println("failed to getifaddrs")
      sys.exit(1)
    }
  }
  </code></pre>
  </section>
  


  <section>
  <h4>Limitations of CStruct</h4>
  <pre><code data-trim data-noescape>
  type Ifaddrs = CStruct7[
  //Ptr[Ifaddrs] see scala-native#634
    Ptr[CInt],     // [1] ifa_next

    Ptr[CChar],    // [2] ifa_name
    CInt,          // [3] ifa_flags
    Ptr[SockAddr], // [4] ifa_addr
    Ptr[SockAddr], // [5] ifa_netmask
    Ptr[SockAddr], // [6] ifa_ifu
    Ptr[Byte]      // [7] ifa_data (void*)
  ]
  </code></pre>
  </section>

  <section>
  <h4>$$$ Richer Types $$$</h4>
  <pre><code data-trim data-noescape>
  implicit class IfaddrsOps(val ptr: Ptr[Ifaddrs]){
    // scala-native#634
    def next: Ptr[Ifaddrs]  = (!(ptr._1)).cast[Ptr[Ifaddrs]]
    
    def name: Ptr[CChar]    = !(ptr._2)
    def flags: <mark>SiocgifFlags</mark> = new SiocgifFlags(!(ptr._3))
    def addr: Ptr[SockAddr] = !(ptr._4)
    def data: Ptr[Byte]     = !(ptr._7)
    
    // scala-native#367 we need to manually box Ptr[T]
    def iterator: <mark>Iterator[IfaddrsOps]</mark> = new Iterator[IfaddrsOps]{
      private var current = new IfaddrsOps(ptr)

      def hasNext: Boolean = current.ptr.next != null
      
      def next(): IfaddrsOps = {
        current = new IfaddrsOps(current.next)
        current
      }
    }
  }
  </code></pre>
  </section>

  <section>
  <h4>AnyVal</h4>
  <pre><code data-trim data-noescape>
  class SiocgifFlags(val value: CInt) extends AnyVal {
    def &(other: SiocgifFlags): Boolean =
      (value & other.value) == other.value
  }
  object SiocgifFlags {
    val Up       = new SiocgifFlags(1 << 1)
    val Loopback = new SiocgifFlags(1 << 4)
    val Running  = new SiocgifFlags(1 << 6)
    // ...
  }
  </code></pre>
  </section>

</section>


<section>
  <section>
    <h2>Implementation Plan</h2>
    <ul>
      <li>Redraw Loop</li>
      <li>Find Network Interface Name</li>
      <li><mark>Get Bitrate</mark></li>
      <li>Draw Bitrate Graph</li>
    </ul>
  </section>

  <section>
  <h4>Total Received/Transmitted</h4>
  <pre><code data-trim data-noescape>
  case class Counters(
    val rx: CUnsignedLong,
    val tx: CUnsignedLong
  )

  object Counters {
    def apply(stats: Ptr[RtnlLinkStats]): Counters =
      Counters(stats.rxBytes, stats.txBytes)
  }

  def getCounter(interfaceName: String): Option[Counters] = {
    withIfaddrs(
      _.find(interface =>
        fromCString(interface.name) == interfaceName &&
        ifa.addr != null &&
        ifa.addr.family == Packet
      )
      .map(interface => 
        Counters(ifa.data.cast[Ptr[RtnlLinkStats]])
      )
    )
  }
  </code></pre>
  </section>

  <section>
  <h4>Catch 22</h4>
  <pre><code data-trim data-noescape>
  type RtnlLinkStats = CStruct22[
    CUnsignedInt, //  [1] rx_packets
    CUnsignedInt, //  [2] tx_packets
    CUnsignedInt, //  [3] rx_bytes
    CUnsignedInt, //  [4] tx_bytes
    CUnsignedInt, //  [5] rx_errors
    CUnsignedInt, //  [6] tx_errors
    CUnsignedInt, //  [7] rx_dropped
    CUnsignedInt, //  [8] tx_dropped
    CUnsignedInt, //  [9] multicast
    CUnsignedInt, // [10] collisions
    CUnsignedInt, // [11] rx_length_errors
    CUnsignedInt, // [12] rx_over_errors
    CUnsignedInt, // [13] rx_crc_errors
    CUnsignedInt, // [14] rx_frame_errors
    CUnsignedInt, // [15] rx_fifo_errors
    CUnsignedInt, // [16] rx_missed_errors
    CUnsignedInt, // [17] tx_aborted_errors
    CUnsignedInt, // [18] tx_carrier_errors
    CUnsignedInt, // [19] tx_fifo_errors
    CUnsignedInt, // [20] tx_heartbeat_errors
    CUnsignedInt, // [21] tx_window_errors
    CUnsignedInt  // [22] rx_compressed

    // we are limited to 22 fields scala-native#637
    // it's ok to ignore those since we don't allocate RtnlLinkStats64
    // CUnsignedInt, // [23] tx_compressed
    // CUnsignedInt  // [24] rx_nohandler
  ]
  </code></pre>
  </section>

  <section>
  <h4>< 22 we are safe</h4>
  <pre><code data-trim data-noescape> 
  <mark>ifa.data.cast[Ptr[RtnlLinkStats]]</mark>

  implicit class RtnlLinkStatsOps(val ptr: Ptr[RtnlLinkStats]){
    def rxBytes: CUnsignedInt = !(ptr._3)
    def txBytes: CUnsignedInt = !(ptr._4)
  }
  </code></pre>
  </section>

  <section>
  <h4>Funky Types</h4>
  <pre><code data-trim data-noescape>
  <mark>ifa.addr.family == Packet</mark>

  type _14 = Nat.Digit[Nat._1, Nat._4]
  type SockAddr = CStruct2[
    CInt,              // [1] sa_family
    CArray[CChar, _14] // [2] sa_data
  ]
  implicit class SockAddrOps(val ptr: Ptr[SockAddr]) {
    def family: SaFamily         = new SaFamily(!(ptr._1))
    def data: CArray[CChar, _14] = !(ptr._2)
  }
  class SaFamily(val value: CInt) extends AnyVal
  object SaFamily {
    final val Packet = new SaFamily(17)
    // ...
  }
  </code></pre>
  </section>

</section>


    </div>
  </div>

  <script src="assets/scripts/libs.js"></script>

  <script src="assets/scripts/app.js"></script>

</body>
</html>
